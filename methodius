#!/usr/bin/bash

Bootstrap(){

    echo -e "\n\tInstalling templates"
    mkdir -p ~/.local/share/pandoc/templates
    cp $PWD/templates/* ~/.local/share/pandoc/templates

    echo -e "\n\tInstalling texlive"
    sudo xbps-install texlive-bin texlive-latexextra \
    && source /etc/profile \
    && sudo tlmgr install adjustbox babel-german background \
    bidi collectbox csquotes everypage filehook footmisc \
    footnotebackref framed fvextra letltxmacro ly1 mdframed \
    mweights needspace pagecolor sourcecodepro \
    sourcesanspro titling ucharcat ulem unicode-math upquote xecjk xurl zref\
    || { echo -e "\n\tfailed to install texlive" \
    && return 1; }

    echo -e "\n\tInstalling npm as build dependency for pandoc-url2cite"
    sudo xbps-install nodejs \
    || { echo -e "\n \tfailed to install pandoc-url2cite" \
    && return 1; }

    echo -e "\n\tInstalling pandoc-url2cite"
    sudo npm install -g pandoc-url2cite \
    || { echo -e "\n \tfailed to install pandoc-url2cite" \
    && return 1; }

    echo -e "\n\tInstalling tectonic"
    sudo xbps-install tectonic \
    || { echo -e "\n \tfailed to install tectonic" \
    && return 1; }

return 0
}

Help(){
    echo -e "\n\tThis tool allows you to easily compile markdown documents into pdf text\
    \n\n\tUsage: [file] -option(s) \
    \n\tIf only a file is specified the default CSL and template will be used \
    \n\n\tOptions: \n\t-h: print this help and exit \
    \n\t-c: path to csl file \
    \n\t-t: path to latex template \
    \n\t-nf: do not apply citation filters \
    \n\t-no: do not open the pdf after conversion \
    \n\t-b: bootstrap this helper" 
}

SetTemplate(){
    if [[ -z $template ]] ; then
        template="methodius"
    fi
    if [[ -z $CSL ]] ; then
        CSL="$HOME/.local/share/pandoc/templates/chicago_note.csl"
    fi
    if [[ $nofilters ]] ; then
    filters=""
    else
    filters="--filter=pandoc-url2cite --filter=pandoc-citeproc"
    fi
    if [[ -v $open_after ]] ; then
    open_after=true
    fi
    if [[ -v $devour ]] ; then
    devour=true
    fi
}

Convertpdf(){
    pandoc \
    $filters \
    --csl $CSL \
    --pdf-engine=tectonic \
    --template $template \
    -s $file \
    -o $output \
    && return 0 || return 1
}

Post_open() {
    if $open_after ; then
        if $devour ; then
            devour zathura $output || exo-open $output
        else
            zathura $output || exo-open $output
        fi
    fi
}

POSITIONAL=()
while [[ $# -gt 0 ]]
do
key="$1"

case $key in
    -b|--bootstrap)
    EXTENSION="$2"
    Bootstrap && exit 0 || exit 1
    ;;
    -t|--template)
    template="$2"
    shift
    shift
    ;;
    -c|--csl)
    CSL="$2"
    shift 
    shift
    ;;
    -h|--help)
    Help && exit 0
    ;;
    -nf|--filters)
    nofilters=true
    shift
    ;;
    -no|--no-open)
    open_after=false
    shift
    ;;
    -nd|--no-devour)
    devour=false
    shift
    ;;
    *)
    POSITIONAL+=("$1")
    shift
    ;;
esac
done
set -- "${POSITIONAL[@]}" # restore positional parameters

file=$1
base=$(basename $1)
output="${base%%.*}.pdf"

SetTemplate
echo -e "\t[INPUT VARIABLES]\n\tinput: $file \n\ttemplate: $template \n\tCSL: $CSL \n\toutput: $output\n"
Convertpdf && Post_open